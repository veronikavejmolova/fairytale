<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8"/>
    <title>V√Ωsledek poh√°dky</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        textarea#story {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            font-family: inherit;
            font-size: 1.1em;
            border: 1px solid #ccc;
            border-radius: 8px;
            resize: vertical;
            margin-bottom: 20px;
            box-sizing: border-box; /* Ensures padding doesn't affect width */
        }

        .controls {
            margin-bottom: 20px;
        }

        #loading {
            margin-top: 10px;
            color: #666;
            font-style: italic;
        }

        #copied {
            color: green;
            margin-left: 10px;
            font-weight: bold;
        }

        button {
            cursor: pointer;
            padding: 8px 12px;
            font-size: 1em;
        }
    </style>
</head>
<body>

    <h1>üßö‚Äç‚ôÇÔ∏è Tvoje poh√°dka</h1>

    <div id="summary" style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <strong>T√©ma:</strong> {{ theme }} <br>
        <strong>Vƒõk d√≠tƒõte:</strong> {{ age }} <br>
        <strong>Hlavn√≠ postava:</strong> {{ character }} <br>
        <strong>Ponauƒçen√≠:</strong> {{ moral }} <br>
        {% if prompt %}
        <strong>Dal≈°√≠ n√°pady:</strong> {{ prompt }} <br>
        {% endif %}
    </div>

    <h2>Tv√° vygenerovan√° poh√°dka:</h2>
    <p><i>(Text m≈Ø≈æe≈° p≈ôed p≈ôeƒçten√≠m upravit)</i></p>

    <textarea id="story">{{ story }}</textarea>

    <div class="controls">
        <button id="copyBtn">üìã Zkop√≠rovat text</button>
        <span id="copied" style="display:none;">‚úî Zkop√≠rov√°no!</span>

        <br><br>

        <button id="playAudioBtn">üéß P≈ôehr√°t nahr√°vku</button>
        <div id="loading" style="display:none;">Generuji hlas...</div>
        <audio id="audioPlayer" controls style="display:none; margin-top: 10px; width: 100%;"></audio>

        <br><br>

        <button id="newStoryBtn">üîÑ Zaƒç√≠t znovu</button>
    </div>

    <hr>

    <h3>Nel√≠b√≠ se ti d√©lka? Zkus to znovu:</h3>
    <form action="/generate" method="post" style="margin-top: 15px;">
        <input type="hidden" name="theme" value="{{ theme }}">
        <input type="hidden" name="character" value="{{ character }}">
        <input type="hidden" name="moral" value="{{ moral }}">
        <input type="hidden" name="prompt" value="{{ prompt }}">
        <input type="hidden" name="age" value="{{ age }}">

        <button type="submit" name="length" value="short">Kr√°tk√° verze</button>
        <button type="submit" name="length" value="medium">St≈ôedn√≠ verze</button>
        <button type="submit" name="length" value="long">Dlouh√° verze</button>
    </form>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Element References
        const storyInput = document.getElementById("story");
        const copyBtn = document.getElementById("copyBtn");
        const copiedMsg = document.getElementById("copied");
        const playBtn = document.getElementById("playAudioBtn");
        const loading = document.getElementById("loading");
        const audioPlayer = document.getElementById("audioPlayer");
        const newStoryBtn = document.getElementById("newStoryBtn");

        // --- 1. Copy Functionality ---
        copyBtn.addEventListener("click", async () => {
            try {
                // Modern approach
                await navigator.clipboard.writeText(storyInput.value);
            } catch (err) {
                // Fallback for older browsers
                storyInput.select();
                document.execCommand("copy");
            }

            // Show success message
            copiedMsg.style.display = "inline";
            setTimeout(() => copiedMsg.style.display = "none", 1500);
        });

        // --- 2. Audio Player Functionality (Async/Await) ---
        playBtn.addEventListener("click", async () => {
            // Reset UI state
            loading.style.display = "block";
            playBtn.disabled = true;
            audioPlayer.style.display = "none";

            try {
                const response = await fetch("{{ url_for('tts') }}", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        text: storyInput.value,
                        voice_id: "piwFF76q4v4xA9Wyxu1R"
                    })
                });

                if (!response.ok) {
                    throw new Error(`Chyba serveru: ${response.status}`);
                }

                // Convert response to blob
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);

                // Setup player
                audioPlayer.src = url;
                audioPlayer.style.display = "block";

                // Attempt to auto-play (browsers might block this without interaction)
                try {
                    await audioPlayer.play();
                } catch (playErr) {
                    console.log("Autoplay prevented, user must click play on audio element.");
                }

            } catch (err) {
                console.error(err);
                alert("Nepoda≈ôilo se vygenerovat zvuk: " + err.message);
            } finally {
                // Always reset the loading state, even if there was an error
                loading.style.display = "none";
                playBtn.disabled = false;
            }
        });

        // --- 3. New Story Button ---
        newStoryBtn.addEventListener("click", () => {
            window.location.href = "{{ url_for('theme') }}";
        });
    });
</script>
</body>
</html>