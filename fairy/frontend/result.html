<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8"/>
    <title>VÃ½sledek pohÃ¡dky</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<h1>ğŸ§šâ€â™‚ï¸ Tvoje pohÃ¡dka</h1>

<div class="white-box">

    <div id="summary">
        <strong>TÃ©ma:</strong> {{ theme }} <br>
        <strong>VÄ›k dÃ­tÄ›te:</strong> {{ age }} let <br>
        <strong>HlavnÃ­ postava:</strong> {{ character }} <br>
        <strong>PonauÄenÃ­:</strong> {{ moral }} <br>
        {% if prompt %}
        <strong>DalÅ¡Ã­ nÃ¡pady:</strong> {{ prompt }} <br>
        {% endif %}
    </div>

    <h2>TvÃ¡ vygenerovanÃ¡ pohÃ¡dka:</h2>
    <p><i>(Text mÅ¯Å¾eÅ¡ pÅ™ed pÅ™eÄtenÃ­m upravit)</i></p>

    <textarea id="story">{{ story }}</textarea>

    <div class="status-bar">
        <span id="copied" style="display:none;">âœ” Text zkopÃ­rovÃ¡n do schrÃ¡nky!</span>
        <div id="loading" style="display:none;">â³ Generuji hlas, chvilku strpenÃ­...</div>
    </div>

    <audio id="audioPlayer" controls style="display:none;"></audio>

    <div class="button-row">
        <div class="button-group-left">
            <button id="copyBtn" class="btn-back">ğŸ“‹ ZkopÃ­rovat</button>
            <button id="playAudioBtn">ğŸ§ PÅ™ehrÃ¡t</button>
        </div>
        <button id="newStoryBtn" class="btn-gradient">ğŸ”„ ZaÄÃ­t znovu</button>
    </div>
</div>

<form action="/generate" method="post" style="margin-top: 2rem;">
    <h3 style="margin-top:0; text-align: center;">NelÃ­bÃ­ se ti dÃ©lka? Zkus to znovu:</h3>

    <input type="hidden" name="theme" value="{{ theme }}">
    <input type="hidden" name="character" value="{{ character }}">
    <input type="hidden" name="moral" value="{{ moral }}">
    <input type="hidden" name="prompt" value="{{ prompt }}">
    <input type="hidden" name="age" value="{{ age }}">

    <div class="btn-group-full">
        <button type="submit" name="length" value="short">KrÃ¡tkÃ¡ verze</button>
        <button type="submit" name="length" value="medium">StÅ™ednÃ­ verze</button>
        <button type="submit" name="length" value="long">DlouhÃ¡ verze</button>
    </div>
</form>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const storyInput = document.getElementById("story");
        const copyBtn = document.getElementById("copyBtn");
        const copiedMsg = document.getElementById("copied");
        const playBtn = document.getElementById("playAudioBtn");
        const loading = document.getElementById("loading");
        const audioPlayer = document.getElementById("audioPlayer");
        const newStoryBtn = document.getElementById("newStoryBtn");

        // KopÃ­rovÃ¡nÃ­
        copyBtn.addEventListener("click", async () => {
            try {
                await navigator.clipboard.writeText(storyInput.value);
            } catch (err) {
                storyInput.select();
                document.execCommand("copy");
            }
            copiedMsg.style.display = "inline-flex";
            setTimeout(() => copiedMsg.style.display = "none", 2500);
        });

        // PÅ™ehrÃ¡vÃ¡nÃ­
        playBtn.addEventListener("click", async () => {
            copiedMsg.style.display = "none";
            loading.style.display = "inline-flex";
            playBtn.disabled = true;
            playBtn.style.opacity = "0.7";
            audioPlayer.style.display = "none";

            try {
                const response = await fetch("{{ url_for('tts_stream') }}", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        text: storyInput.value,
                        voice_id: "piwFF76q4v4xA9Wyxu1R"
                    })
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`Chyba serveru (${response.status}): ${errText}`);
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                audioPlayer.src = url;
                audioPlayer.style.display = "block";

                try {
                    await audioPlayer.play();
                } catch (playErr) {
                    console.log("Autoplay blocked");
                }

            } catch (err) {
                console.error(err);
                alert("Chyba: " + err.message);
            } finally {
                loading.style.display = "none";
                playBtn.disabled = false;
                playBtn.style.opacity = "1";
            }
        });

        // ZaÄÃ­t znovu
        newStoryBtn.addEventListener("click", () => {
            window.location.href = "{{ url_for('theme') }}";
        });
    });
</script>
</body>
</html>