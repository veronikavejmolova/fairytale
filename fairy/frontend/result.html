<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8"/>
    <title>V√Ωsledek poh√°dky</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>

        textarea#story {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            font-family: inherit;
            font-size: 1.1em;
            border: 1px solid #ccc;
            border-radius: 8px;
            resize: vertical;
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        .controls {
            margin-bottom: 20px;
        }

        #loading {
            margin-top: 10px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>

    <h1>üßö‚Äç‚ôÇÔ∏è Tvoje poh√°dka</h1>

    <div id="summary" style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <strong>T√©ma:</strong> {{ theme }} <br>
        <strong>Vƒõk d√≠tƒõte:</strong> {{ age }} <br>
        <strong>Hlavn√≠ postava:</strong> {{ character }} <br>
        <strong>Ponauƒçen√≠:</strong> {{ moral }} <br>
        {% if prompt %}
        <strong>Dal≈°√≠ n√°pady:</strong> {{ prompt }} <br>
        {% endif %}
    </div>

    <h2>Tv√° vygenerovan√° poh√°dka:</h2>
    <p><i>(Text m≈Ø≈æe≈° p≈ôed p≈ôeƒçten√≠m upravit)</i></p>

    <textarea id="story">{{ story }}</textarea>

    <div class="controls">
        <button id="copyBtn">üìã Zkop√≠rovat text</button>
        <span id="copied" style="display:none;">‚úî Zkop√≠rov√°no!</span>

        <br><br>

        <button id="playAudioBtn">üéß P≈ôehr√°t nahr√°vku</button>
        <div id="loading" style="display:none;">Generuji hlas (chvilku to potrv√°)...</div>
        <audio id="audioPlayer" controls style="display:none; margin-top: 10px; width: 100%;"></audio>

        <br><br>

        <button id="newStoryBtn">üîÑ Zaƒç√≠t znovu</button>
    </div>

    <hr>

    <h3>Nel√≠b√≠ se ti d√©lka? Zkus to znovu:</h3>
    <form action="/generate" method="post" style="margin-top: 15px;">
        <input type="hidden" name="theme" value="{{ theme }}">
        <input type="hidden" name="character" value="{{ character }}">
        <input type="hidden" name="moral" value="{{ moral }}">
        <input type="hidden" name="prompt" value="{{ prompt }}">
        <input type="hidden" name="age" value="{{ age }}">
        <input type="hidden" name="other_characters" value="{{ other_characters }}">
        <input type="hidden" name="supernatural_present" value="{{ supernatural_present }}">
        <input type="hidden" name="super_types" value="{{ super_types }}">
        <input type="hidden" name="super_tone" value="{{ super_tone }}">

        <button type="submit" name="length" value="short">Kr√°tk√° verze</button>
        <button type="submit" name="length" value="medium">St≈ôedn√≠ verze</button>
        <button type="submit" name="length" value="long">Dlouh√° verze</button>
    </form>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const storyInput = document.getElementById("story");
        const copyBtn = document.getElementById("copyBtn");
        const copiedMsg = document.getElementById("copied");
        const playBtn = document.getElementById("playAudioBtn");
        const loading = document.getElementById("loading");
        const audioPlayer = document.getElementById("audioPlayer");
        const newStoryBtn = document.getElementById("newStoryBtn");

        // --- 1. Copy Functionality ---
        copyBtn.addEventListener("click", async () => {
            try {
                await navigator.clipboard.writeText(storyInput.value);
            } catch (err) {
                storyInput.select();
                document.execCommand("copy");
            }
            copiedMsg.style.display = "inline";
            setTimeout(() => copiedMsg.style.display = "none", 1500);
        });

        // --- 2. Audio Logic (Hybrid: Modern Fetch + Server Polling) ---
        playBtn.addEventListener("click", async () => {
            loading.style.display = "block";
            playBtn.disabled = true;
            audioPlayer.style.display = "none";

            try {
                // KROK A: Z√≠sk√°me Cache Key a inicializujeme po≈æadavek
                const initResponse = await fetch("/tts/api/init", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        text: storyInput.value,
                        voice_id: "piwFF76q4v4xA9Wyxu1R"
                    })
                });

                if (!initResponse.ok) throw new Error("Chyba p≈ôi inicializaci TTS");
                const initData = await initResponse.json();
                const cacheKey = initData.cache_key;

                // KROK B: Spust√≠me generov√°n√≠ na pozad√≠ (fire and forget fetch)
                fetch(`/audio/${cacheKey}/generate`, {method: "POST"});

                // KROK C: Polling - pt√°me se serveru "u≈æ je to hotov√©?"
                const checkStatus = async () => {
                    try {
                        const statusResp = await fetch(`/audio/${cacheKey}/status`);
                        const statusData = await statusResp.json();

                        if (statusData.ready) {
                            // Je to hotov√©! Nastav√≠me p≈ôehr√°vaƒç.
                            loading.style.display = "none";
                            playBtn.disabled = false;

                            // P≈ôid√°me n√°hodn√Ω query parametr (?t=...), aby prohl√≠≈æeƒç necacheoval star√© chyby
                            audioPlayer.src = `/audio/${cacheKey}?t=${new Date().getTime()}`;
                            audioPlayer.style.display = "block";

                            try {
                                await audioPlayer.play();
                            } catch (e) {
                                console.log("Autoplay zablokov√°n prohl√≠≈æeƒçem, u≈æivatel mus√≠ kliknout play.");
                            }
                        } else {
                            // Nen√≠ hotov√©, zkus√≠me to znovu za 2 sekundy
                            setTimeout(checkStatus, 2000);
                        }
                    } catch (err) {
                        console.error("Chyba p≈ôi status checku:", err);
                        loading.innerText = "Chyba p≈ôi kontrole stavu.";
                    }
                };

                // Spust√≠me prvn√≠ kontrolu
                checkStatus();

            } catch (err) {
                console.error(err);
                alert("Nepoda≈ôilo se zah√°jit generov√°n√≠ zvuku: " + err.message);
                loading.style.display = "none";
                playBtn.disabled = false;
            }
        });

        // --- 3. New Story Button ---
        newStoryBtn.addEventListener("click", () => {
            window.location.href = "{{ url_for('theme') }}";
        });
    });
</script>
</body>
</html>